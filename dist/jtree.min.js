!function(t,e,n){"use strict";function i(t){var e=null;if("object"!=typeof t)return t;if(t instanceof Array){e=[];for(var n=0;n<t.length;n++)e.push(i(t[n]));return e}if(t instanceof Object){e={};for(var s in t)e[s]=i(t[s]);return e}}function s(t,e,n){this._data=e,this._token=null,this._tokenPool=t,this._el=null,this._children=[],this._parent=n||null,this._lazy=!1,this._expanded=!1,this._isEditing=!1,this._init(t)}function a(){this._tokens=[]}function d(t,e){this._data=t||null,this._tokenPool=new a,this._el=e||null,this._elRoot=null,this._elMenu=null,this._menuShowing=!1,this._clipBoard=null,this._init()}var l={get:function(t,e,n){if(t){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status){var t=JSON.parse(i.responseText);e instanceof Function&&e(t)}else n instanceof Function&&n()},i.open("GET",t,!0),i.send(null)}}},o={addHandler:function(t,e,n,i){t.attachEvent?t.attachEvent("on"+e,n):t.addEventListener?t.addEventListener(e,n,i||!1):t["on"+e]=n},removeHandler:function(t,e,n,i){t.removeEventListener?t.removeEventListener(e,n,i||!1):t.detachEvent?t.detachEvent("on"+e,n):t["on"+e]=null},setScope:function(t,e){return function(){e.call(t,arguments[0])}},computedStyle:function(t,e){return t.currentStyle?t.currentStyle[e]:getComputedStyle(t,null)[e]},select:function(t){var n=e.createRange();t?n.selectNodeContents(t):n.collapse();var i=getSelection();i.removeAllRanges(),i.addRange(n),n.detach(),n=null,i=null},deepCopy:i},r={map:{text:{html:"html",css:"css",plain:"txt"},application:{js:"js",pdf:"pdf","vnd.ms-powerpoint":"ppt",msword:"word","vnd.ms-excel":"xls",zip:"zip"},image:"pic",video:"video",audio:"audio"},getFormat:function(t){var e=t.split("/"),n=e[0],i=e[1],s=this.map[n];return s?"string"==typeof s?s:s[i]:null}},h={};for(var _ in r.map){var c=r.map[_];if("string"==typeof c)h[c]="dt-node__icon--"+c;else for(var u in c){var p=c[u];h[p]="dt-node__icon--"+p}}r.classname=h;var f={CLASS_NAME:{NODE:"dt-node",NODE_WRAP:"dt-node__wrap",NODE_HEAD:"dt-node__head",NODE_BODY:"dt-node__body",NODE_BODY_OPEN:"dt-node__body--open",NODE_ICON_LOADING:"dt-node__icon--loading",NODE_ICON_FOLDER:"dt-node__icon--folder",NODE_ICON_OPEN:"dt-node__icon--open",NODE_ICON_UNKNOWN:"dt-node__icon--unknown",NODE_TITLE:"dt-node__title",NODE_TITLE_FOUND:"dt-node__title--found",MENU:"dt-menu",SEARCH:"dt-search"},MENU:{TPL:'<div><ul><li><a name="create">create</a></li><li><a name="delete">delete</a></li><li><a name="rename">rename</a></li><li><a name="search">search</a><ul><li><input class="dt-search" type="text" placeholder="Input keywords"></li></ul></li><li><a>Edit</a><ul><li><a name="cut">cut</a></li><li><a name="copy">copy</a></li><li><a name="paste">paste</a></li></ul></li></ul></div>'},TPL:'<div class="dt-node__wrap"><div class="dt-node__head"><span></span><span class="dt-node__title">{title}</span></div><div class="dt-node__body"></div></div>',currentNode:function(t){return t.classList.contains(this.CLASS_NAME.NODE_ICON)?t.parentNode.parentNode.parentNode:t.classList.contains(this.CLASS_NAME.NODE_TITLE)?t.parentNode.parentNode.parentNode:null},getIcon:function(t){return t.firstChild.firstChild.firstChild},getHead:function(t){return t.firstChild.firstChild},getBody:function(t){return t.firstChild.lastChild},getTitle:function(t){return t.firstChild.firstChild.firstChild.nextElementSibling},appendMenu:function(t,e){var n=this.getHead(t);n.appendChild(e)},menuParent:function(t){return t.parentNode.parentNode.parentNode}},E={FOLDER:0,FILE:1},v=f.CLASS_NAME,N=13;s.prototype={constructor:s,_init:function(){this._render(this._tokenPool);var t=this._data,e=f.getIcon(this._el);if(t.type==E.FILE){var n=null;t.mime&&(n=r.getFormat(t.mime))?e.classList.add(r.classname[n]):e.classList.add(v.NODE_ICON_UNKNOWN)}else t.type===E.FOLDER&&e.classList.add(v.NODE_ICON_FOLDER);if("string"==typeof t.children)this._lazy=!0;else if(t.children instanceof Array)for(var i=0;i<t.children.length;i++){var a=new s(this._tokenPool,t.children[i],this);this.appendChild(a)}},_render:function(){var t=this._data;this._el=e.createElement("div"),this._el.classList.add(v.NODE),this._el.innerHTML=f.TPL.replace("{title}",t.title);var n=this._tokenPool.add(this);this._el.dataset.dtToken=n,this._token=n},_loadSuccess:function(t){if(t){var e=new s(this._tokenPool,t,this);this.appendChild(e),this._data.children=[t]}var n=f.getIcon(this._el);n.classList.remove(v.NODE_ICON_LOADING),n.classList.add(v.NODE_ICON_FOLDER),this.expand()},_loadError:function(){alert(this._data.title+" load error!")},appendChild:function(t){var e=f.getBody(this._el);e.appendChild(t.$element()),this._children.push(t)},removeChild:function(t){var e=this._children.indexOf(t);return t.$element().remove(),this._children.splice(e,1),e},enableEdit:function(){var t=f.getTitle(this._el);o.select(t)},disableEdit:function(){var t=f.getTitle(this._el);t.contentEditable="false",o.select()},expand:function(){if(this._data.type==E.FOLDER){var t=f.getIcon(this._el),e=f.getBody(this._el);t.classList.add(v.NODE_ICON_OPEN),e.classList.add(v.NODE_BODY_OPEN),this._expanded=!0}},fold:function(){if(this._data.type==E.FOLDER){var t=f.getIcon(this._el),e=f.getBody(this._el);t.classList.remove(v.NODE_ICON_OPEN),e.classList.remove(v.NODE_BODY_OPEN),this._expanded=!1}},toggleChildren:function(){if(this._expanded)this.fold();else if(this._lazy&&"string"==typeof this._data.children){var t=this._data.children;l.get(t,o.setScope(this,this._loadSuccess),o.setScope(this,this._loadError));var e=f.getIcon(this._el);e.classList.remove(v.NODE_ICON_FOLDER),e.classList.add(v.NODE_ICON_LOADING)}else this.expand()},search:function(t){var e=!1,n=f.getTitle(this._el);n.classList.remove(v.NODE_TITLE_FOUND);for(var i=0;i<this._children.length;i++)e=this._children[i].search(t)||e;return this._data.title.indexOf(t)>=0&&(e=!0,n.classList.add(v.NODE_TITLE_FOUND)),e&&this.expand(),e},delete:function(){var t=this._parent;if(t){var e=t.removeChild(this);this._data.splice(e,1)}},create:function(){var t={title:"new",type:E.FOLDER,children:[]},e=new s(this._tokenPool,t);this.appendChild(e),this.expand(),e.rename(),this._data.children.push(t)},rename:function(){var t=f.getTitle(this._el);if(this._isEditing){var e=t.innerHTML.trim();this._isEditing=!1,this._data.title=e}else t.contentEditable="true",t.focus(),this._isEditing=!0},paste:function(t){t&&this._data.type==E.FOLDER&&(this.appendChild(t),this.expand(),this._data.children.push(t._data))},copy:function(){var t=o.deepCopy(this._data);return new s(this._tokenPool,t)},cut:function(){if(this._parent){var t=this._parent.removeChild(this);return this._parent.$data().children.splice(t,1),this}return null},$element:function(){return this._el},$data:function(){return this._data}},a.prototype={constructor:a,get:function(t){return this._tokens[t]},add:function(t){var e=this._tokens.length;return this._tokens.push(t),e}},d.prototype={constructor:d,_init:function(){if(this._data){var t=new s(this._tokenPool,this._data);this._elRoot=t.$element(),this._el?this._el.appendChild(this._elRoot):this._el=this._elRoot,this._renderMenu(),this._bind()}},_renderMenu:function(){this._elMenu=e.createElement("div"),this._elMenu.innerHTML=f.MENU.TPL,this._elMenu.classList.add(v.MENU)},_bind:function(){o.addHandler(this._el,"click",o.setScope(this,this._toggleChildren)),o.addHandler(this._el,"contextmenu",o.setScope(this,this._toggleMenu)),o.addHandler(t,"click",o.setScope(this,this._toggleMenu)),o.addHandler(this._elMenu,"click",o.setScope(this,this._clickMenu)),o.addHandler(this._el,"focus",o.setScope(this,this._enableEdit),!0),o.addHandler(this._el,"blur",o.setScope(this,this._disableEdit),!0),o.addHandler(this._el,"keydown",o.setScope(this,this._disableEdit)),o.addHandler(this._elMenu,"blur",o.setScope(this,this._search),!0),o.addHandler(this._elMenu,"keydown",o.setScope(this,this._search))},_showMenu:function(t){f.appendMenu(t,this._elMenu),this._menuShowing=!0},_hideMenu:function(){try{this._elMenu.remove()}catch(t){}finally{this._menuShowing=!1}},_toggleChildren:function(t){var e=t.target,n=f.currentNode(e);if(n){var i=this._tokenPool.get(n.dataset.dtToken);i.toggleChildren()}e.classList.remove(v.NODE_TITLE_FOUND)},_toggleMenu:function(t){var e=t.target,n=t.type.toLowerCase();"contextmenu"===n?(t.preventDefault(),e.classList.contains(v.NODE_TITLE)&&(this._menuEventFlowing=!0,this._menuShowing?this._hideMenu():this._showMenu(f.currentNode(e)))):"click"===n&&0===t.button&&this._menuShowing&&this._hideMenu()},_clickMenu:function(t){var e=t.target,n=e.name,i=f.menuParent(this._elMenu),s=this._tokenPool.get(i.dataset.dtToken);if(n){var a=s[n](this._clipBoard);this._clipBoard=a||this._clipBoard}},_enableEdit:function(t){var e=t.target,n=f.currentNode(e);if(n){var i=this._tokenPool.get(n.dataset.dtToken);i.enableEdit()}},_disableEdit:function(t){if(("blur"===t.type||"keydown"===t.type&&t.keyCode==N)&&"true"===t.target.contentEditable){var e=t.target,n=f.currentNode(e),i=this._tokenPool.get(n.dataset.dtToken);i.disableEdit(),i.rename()}},_search:function(t){if(("blur"===t.type||"keydown"===t.type&&t.keyCode==N)&&t.target.classList.contains(v.SEARCH)){var e=t.target.value.trim(),n=f.menuParent(this._elMenu),i=this._tokenPool.get(n.dataset.dtToken);if(e){i.search(e);this._hideMenu()}}},$element:function(){return this._el}},t.Tree=d}(window,document);