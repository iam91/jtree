!function(t,e,i){"use strict";function n(t){var e=null;if("object"!=typeof t)return t;if(t instanceof Array){e=[];for(var i=0;i<t.length;i++)e.push(n(t[i]));return e}if(t instanceof Object){e={};for(var s in t)e[s]=n(t[s]);return e}}function s(t,e,i){this._data=e,this._token=null,this._tokenPool=t,this._depth=i&&i.getDepth()+1||0,this._el=null,this._children=[],this._parent=i||null,this._lazy=!1,this._selected=!1,this._expanded=!1,this._isEditing=!1,this._isFolder=!1,this._init(t)}function a(){this._tokens=[]}function d(t,e){this._data=l.deepCopy(t)||null,this._tokenPool=new a,this._el=e||null,this._elRoot=null,this._elMenu=null,this._menuShowing=!1,this._clipBoard=null,this._selectedNode=null,this._draggedNode=null,this._init()}var o={get:function(t,e,i){if(t){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var t=JSON.parse(n.responseText);e instanceof Function&&e(t)}else i instanceof Function&&i()},n.open("GET",t,!0),n.send(null)}}},l={addHandler:function(t,e,i,n){t.attachEvent?t.attachEvent("on"+e,i):t.addEventListener?t.addEventListener(e,i,n||!1):t["on"+e]=i},removeHandler:function(t,e,i,n){t.removeEventListener?t.removeEventListener(e,i,n||!1):t.detachEvent?t.detachEvent("on"+e,i):t["on"+e]=null},setScope:function(t,e){return function(){e.call(t,arguments[0])}},computedStyle:function(t,e){return t.currentStyle?t.currentStyle[e]:getComputedStyle(t,null)[e]},select:function(t){var i=e.createRange();t?i.selectNodeContents(t):i.collapse();var n=getSelection();n.removeAllRanges(),n.addRange(i),i.detach(),i=null,n=null},deepCopy:n},r={map:{text:{html:"html",css:"css",plain:"txt"},application:{js:"js",pdf:"pdf","vnd.ms-powerpoint":"ppt",msword:"word","vnd.ms-excel":"xls",zip:"zip"},image:"pic",video:"video",audio:"audio"},getFormat:function(t){var e=t.split("/"),i=e[0],n=e[1],s=this.map[i];return s?"string"==typeof s?s:s[n]:null}},h={};for(var c in r.map){var _=r.map[c];if("string"==typeof _)h[_]="dt-node__icon--"+_;else for(var u in _){var p=_[u];h[p]="dt-node__icon--"+p}}h.unknown="dt-node__icon--unknown";var f={INDENT:1,CLASS_NAME:{NODE:"dt-node",NODE_OPEN:"dt-node--open",SELECTED:"dt-node--sel",SELECTED_BLUR:"dt-node--selblur",COVERED:"dt-node--covered",NODE_HEAD:"dt-node__head",NODE_BODY:"dt-node__body",NODE_SWITCH:"dt-node__switch",NODE_SWITCH_HIDE:"dt-node__switch--hide",NODE_ICON:"dt-node__icon",NODE_ICON_LOADING:"dt-node__icon--loading",NODE_ICON_FOLDER:"dt-node__icon--folder",NODE_ICON_MIME:h,NODE_TITLE:"dt-node__title",NODE_TITLE_FOUND:"dt-node__title--found",MENU:"dt-menu",SEARCH:"dt-search"},MENU:{TPL:'<div><ul><li><a name="create">create</a></li><li><a name="delete">delete</a></li><li><a name="rename">rename</a></li><li><a name="search">search</a><ul><li><input class="dt-search" type="text" placeholder="Input keywords"></li></ul></li><li><a>Edit</a><ul><li><a name="cut">cut</a></li><li><a name="copy">copy</a></li><li><a name="paste">paste</a></li></ul></li></ul></div>'},TPL:'<div class="dt-node__head"><span class="dt-node__switch"></span><span class="dt-node__icon"></span><span class="dt-node__title">{title}</span></div><div class="dt-node__body"></div>',isIcon:function(t){return t.classList.contains(this.CLASS_NAME.NODE_ICON)},isTitle:function(t){return t.classList.contains(this.CLASS_NAME.NODE_TITLE)},isHead:function(t){return t.classList.contains(this.CLASS_NAME.NODE_HEAD)},isSwitch:function(t){return t.classList.contains(this.CLASS_NAME.NODE_SWITCH)},isSelected:function(t){return t.classList.contains(this.CLASS_NAME.SELECTED)},isSearch:function(t){return t.classList.contains(this.CLASS_NAME.SEARCH)},currentNode:function(t){return this.isIcon(t)||this.isTitle(t)||this.isSwitch(t)?t.parentNode.parentNode:this.isHead(t)?t.parentNode:null},getSwitch:function(t){return t.firstChild.firstChild},getIcon:function(t){return t.firstChild.firstChild.nextElementSibling},getHead:function(t){return t.firstChild},getBody:function(t){return t.lastChild},getTitle:function(t){return t.firstChild.firstChild.nextElementSibling.nextElementSibling},setIcon:function(t,e,i){var n=this.getIcon(t);e===E.FILE?n.classList.add(this.CLASS_NAME.NODE_ICON_MIME[i]):e===E.FOLDER&&n.classList.add(this.CLASS_NAME.NODE_ICON_FOLDER)},switchHide:function(t){var e=this.getSwitch(t);e.classList.add(this.CLASS_NAME.NODE_SWITCH_HIDE)},expand:function(t){t.classList.add(this.CLASS_NAME.NODE_OPEN)},fold:function(t){t.classList.remove(this.CLASS_NAME.NODE_OPEN)},startLoad:function(t){var e=f.getIcon(t);e.classList.remove(this.CLASS_NAME.NODE_ICON_FOLDER),e.classList.add(this.CLASS_NAME.NODE_ICON_LOADING)},stopLoad:function(t){var e=f.getIcon(t);e.classList.remove(this.CLASS_NAME.NODE_ICON_LOADING),e.classList.add(this.CLASS_NAME.NODE_ICON_FOLDER)},select:function(t){t.classList.add(this.CLASS_NAME.SELECTED),t.classList.remove(this.CLASS_NAME.SELECTED_BLUR)},selblur:function(t){t.classList.add(this.CLASS_NAME.SELECTED_BLUR),t.classList.remove(this.CLASS_NAME.SELECTED)},unselect:function(t){t.classList.remove(this.CLASS_NAME.SELECTED),t.classList.remove(this.CLASS_NAME.SELECTED_BLUR)},cover:function(t){t.classList.add(this.CLASS_NAME.COVERED)},uncover:function(t){t.classList.remove(this.CLASS_NAME.COVERED)},setFound:function(t){var e=f.getTitle(t);e.classList.add(this.CLASS_NAME.NODE_TITLE_FOUND)},clearFound:function(t){var e=f.getTitle(t);e.classList.remove(this.CLASS_NAME.NODE_TITLE_FOUND)},appendMenu:function(t,e){var i=this.getHead(t);i.appendChild(e)},menuParent:function(t){return t.parentNode.parentNode}},E={FOLDER:0,FILE:1},g=f.CLASS_NAME,v=13;s.prototype={constructor:s,_init:function(){this._render(),this._setToken(),this._addIcon();var t=this._data;if("string"==typeof t.children)this._lazy=!0;else if(t.children instanceof Array)for(var e=0;e<t.children.length;e++){var i=new s(this._tokenPool,t.children[e],this);this.appendChild(i)}},_addIcon:function(){var t=this._data;if(t.type===E.FILE){var e=t.mime&&r.getFormat(t.mime)||"unknown";f.switchHide(this._el),f.setIcon(this._el,t.type,e),this._isFolder=!1}else t.type===E.FOLDER&&(f.setIcon(this._el,t.type),this._isFolder=!0)},_indent:function(){var t=f.getHead(this._el);t.style.paddingLeft=f.INDENT*this._depth+"rem"},_setToken:function(){var t=this._tokenPool.add(this);this._el.dataset.dtToken=t,this._token=t},_render:function(){this._el=e.createElement("div"),this._el.classList.add(g.NODE),this._el.draggable="true",this._el.innerHTML=f.TPL.replace("{title}",this._data.title)},_loadSuccess:function(t){if(t){var e=new s(this._tokenPool,t,this);this.appendChild(e),this._data.children=[t],this._lazy=!1}this._stopLoad(),this._expand()},_loadError:function(){alert(this._data.title+" data load error!"),this._stopLoad()},_startLoad:function(){f.startLoad(this._el)},_stopLoad:function(){f.stopLoad(this._el)},_expand:function(){this._isFolder&&(f.expand(this._el),this._expanded=!0)},appendChild:function(t){var e=f.getBody(this._el);e.appendChild(t.getElem()),this._children.push(t),t.setDepth(this.getDepth()+1)},removeChild:function(t){var e=this._children.indexOf(t);return t.getElem().remove(),this._children.splice(e,1),e},enableEdit:function(){var t=f.getTitle(this._el);l.select(t)},disableEdit:function(){var t=f.getTitle(this._el);t.contentEditable="false",l.select()},expand:function(){if(this._lazy&&"string"==typeof this._data.children){var t=this._data.children;o.get(t,l.setScope(this,this._loadSuccess),l.setScope(this,this._loadError)),this._startLoad()}else this._expand()},fold:function(){this._isFolder&&(f.fold(this._el),this._expanded=!1)},toggleChildren:function(){this._expanded?this.fold():this.expand()},search:function(t){var e=!1;f.getTitle(this._el);f.clearFound(this._el);for(var i=0;i<this._children.length;i++)e=this._children[i].search(t)||e;return this._data.title.indexOf(t)>=0&&(e=!0,f.setFound(this._el)),e&&this.expand(),e},delete:function(){var t=this._parent;if(t){var e=t.removeChild(this);this._data.splice(e,1)}},create:function(){var t={title:"new",type:E.FOLDER,children:[]},e=new s(this._tokenPool,t);this.appendChild(e),this.expand(),e.rename(),this._data.children.push(t)},rename:function(){var t=f.getTitle(this._el);if(this._isEditing){var e=t.innerHTML.trim();this._isEditing=!1,this._data.title=e}else t.contentEditable="true",t.focus(),this._isEditing=!0},paste:function(t){t&&this._isFolder&&(this.appendChild(t),this.expand(),this._data.children.push(t._data))},copy:function(){var t=l.deepCopy(this._data);return new s(this._tokenPool,t)},cut:function(){if(this._parent){var t=this._parent.removeChild(this);return this._parent.getData().children.splice(t,1),this}return null},selBlur:function(){f.selblur(this._el)},select:function(){this._selected=!0,f.select(this._el)},unselect:function(){this._selected=!1,f.unselect(this._el)},cover:function(){f.cover(this._el)},uncover:function(){f.uncover(this._el)},isSelected:function(){return this._selected},isFolder:function(){return this._isFolder},isLazy:function(){return this._lazy},getElem:function(){return this._el},getData:function(){return this._data},getDepth:function(){return this._depth},setDepth:function(t){if(this._depth=t,this._indent(),this._children.length)for(var e=0;e<this._children.length;e++)this._children[e].setDepth(t+1)}},a.prototype={constructor:a,get:function(t){return this._tokens[t]},add:function(t){var e=this._tokens.length;return this._tokens.push(t),e}},d.prototype={constructor:d,_init:function(){if(this._data){var t=new s(this._tokenPool,this._data);this._elRoot=t.getElem(),this._el?this._el.appendChild(this._elRoot):this._el=this._elRoot,this._renderMenu(),this._bind()}},_renderMenu:function(){this._elMenu=e.createElement("div"),this._elMenu.innerHTML=f.MENU.TPL,this._elMenu.classList.add(g.MENU)},_bind:function(){l.addHandler(this._el,"click",l.setScope(this,this._select)),l.addHandler(this._el,"click",l.setScope(this,this._toggleChildren)),l.addHandler(this._el,"dblclick",l.setScope(this,this._toggleChildren)),l.addHandler(this._el,"contextmenu",l.setScope(this,this._toggleMenu)),l.addHandler(t,"click",l.setScope(this,this._toggleMenu)),l.addHandler(this._elMenu,"click",l.setScope(this,this._clickMenu)),l.addHandler(this._el,"focus",l.setScope(this,this._enableEdit),!0),l.addHandler(this._el,"blur",l.setScope(this,this._disableEdit),!0),l.addHandler(this._el,"keydown",l.setScope(this,this._disableEdit)),l.addHandler(this._elMenu,"blur",l.setScope(this,this._search),!0),l.addHandler(this._elMenu,"keydown",l.setScope(this,this._search)),l.addHandler(t,"click",l.setScope(this,this._selBlur)),l.addHandler(this._el,"dragstart",l.setScope(this,this._dragStart)),l.addHandler(this._el,"dragenter",l.setScope(this,this._dragCover)),l.addHandler(this._el,"dragleave",l.setScope(this,this._dragCover)),l.addHandler(this._el,"dragover",l.setScope(this,this._dragOver)),l.addHandler(this._el,"drop",l.setScope(this,this._dragDrop))},_showMenu:function(t){f.appendMenu(t,this._elMenu),this._menuShowing=!0},_hideMenu:function(){try{this._elMenu.remove()}catch(t){}finally{this._menuShowing=!1}},_dragStart:function(t){var e=t.target,i=this._tokenPool.get(e.dataset.dtToken);i.fold(),this._draggedNode=i,t.dataTransfer.setData("text/html",""),t.dataTransfer.setDragImage(e,0,0)},_dragCover:function(t){var e=t.target;if(e=3===e.nodeType?e.parentNode:e,f.isTitle(e)){var i=f.currentNode(e),n=this._tokenPool.get(i.dataset.dtToken);"dragenter"===t.type?(n.cover(),n.expand()):"dragleave"===t.type&&n.uncover()}},_dragOver:function(t){t.preventDefault()},_dragDrop:function(t){var e=t.target;if(f.isTitle(e)){var i=f.currentNode(e),n=this._tokenPool.get(i.dataset.dtToken);if(n.uncover(),n.isFolder()){var s=this._draggedNode;s.cut(),n.paste(s)}}},_selBlur:function(t){var e=f.currentNode(t.target);!e&&this._selectedNode&&this._selectedNode.selBlur()},_select:function(t){var e=t.target,i=t.type;if("click"===i&&f.isTitle(e)){var n=f.currentNode(e);n&&(this._selectedNode&&this._selectedNode.unselect(),this._selectedNode=this._tokenPool.get(n.dataset.dtToken),this._selectedNode.select(),f.clearFound(n))}},_toggleChildren:function(t){var e=t.target,i=t.type,n=null,s=null;("click"===i&&f.isSwitch(e)||"dblclick"===i&&f.isTitle(e))&&(n=f.currentNode(e),n&&(s=this._tokenPool.get(n.dataset.dtToken),s.toggleChildren()))},_toggleMenu:function(t){var e=t.target,i=t.type.toLowerCase();"contextmenu"===i?(t.preventDefault(),f.isTitle(e)&&(this._menuEventFlowing=!0,this._menuShowing?this._hideMenu():this._showMenu(f.currentNode(e)))):"click"===i&&0===t.button&&this._menuShowing&&!f.isSearch(e)&&this._hideMenu()},_clickMenu:function(t){var e=t.target,i=e.name,n=f.menuParent(this._elMenu),s=this._tokenPool.get(n.dataset.dtToken);if(i){var a=s[i](this._clipBoard);this._clipBoard=a||this._clipBoard}},_enableEdit:function(t){var e=t.target,i=f.currentNode(e);if(i){var n=this._tokenPool.get(i.dataset.dtToken);n.enableEdit()}},_disableEdit:function(t){if(("blur"===t.type||"keydown"===t.type&&t.keyCode==v)&&"true"===t.target.contentEditable){var e=t.target,i=f.currentNode(e),n=this._tokenPool.get(i.dataset.dtToken);n.disableEdit(),n.rename()}},_search:function(t){if(("blur"===t.type||"keydown"===t.type&&t.keyCode==v)&&f.isSearch(t.target)){var e=t.target.value.trim(),i=f.menuParent(this._elMenu),n=this._tokenPool.get(i.dataset.dtToken);if(e){n.search(e);this._hideMenu()}}},getElem:function(){return this._el},getData:function(){return this._data}},t.Tree=d}(window,document);